# Grafico stacked con colori più soft
ggplot(ptf_long, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"HMR" = "#0095B6",       # azzurro pastello
"ORE" = "#fdbf6f",       # arancio pastello
"ORA" = "#b2df8a",       # verde chiaro pastello
"BUS" = "#33a02c",       # verde leggermente soft
"OFA" = "#FDE910",       # viola pastello
"ALLSTOCK" = "#FF0000"
),labels = c(
"HMR" = "HMR",
"ORE" = "ORE",
"ORA" = "ORA",
"BUS" = "BUS",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
# Grafico stacked con colori più soft
ggplot(ptf_long, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"HMR" = "#0095B6",       # azzurro pastello
"ORE" = "#FF9933",       # arancio pastello
"ORA" = "#b2df8a",       # verde chiaro pastello
"BUS" = "#33a02c",       # verde leggermente soft
"OFA" = "#FDE910",       # viola pastello
"ALLSTOCK" = "#FF0000"
),labels = c(
"HMR" = "HMR",
"ORE" = "ORE",
"ORA" = "ORA",
"BUS" = "BUS",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
# Grafico stacked con colori più soft
ggplot(ptf_long, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"HMR" = "#ABCDEF",       # azzurro pastello
"ORE" = "#FF9933",       # arancio pastello
"ORA" = "#b2df8a",       # verde chiaro pastello
"BUS" = "#33a02c",       # verde leggermente soft
"OFA" = "#FDE910",       # viola pastello
"ALLSTOCK" = "#FF0000"
),labels = c(
"HMR" = "HMR",
"ORE" = "ORE",
"ORA" = "ORA",
"BUS" = "BUS",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
# Grafico stacked con colori più soft
ggplot(ptf_long, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"HMR" = "#ABCDEF",       # azzurro pastello
"ORE" = "#FF9933",       # arancio pastello
"ORA" = "#b2df8a",       # verde chiaro pastello
"BUS" = "#33a02c",
"ALLSTOCK" = "#FF0000",# verde leggermente soft
"OFA" = "#FDE910",       # viola pastello
),labels = c(
"HMR" = "HMR",
"ORE" = "ORE",
"ORA" = "ORA",
"BUS" = "BUS",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
# Grafico stacked con colori più soft
ggplot(ptf_long, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"HMR" = "#ABCDEF",       # azzurro pastello
"ORE" = "#FF9933",       # arancio pastello
"ORA" = "#b2df8a",       # verde chiaro pastello
"BUS" = "#33a02c",
"ALLSTOCK" = "#FF0000",# verde leggermente soft
"OFA" = "#FDE910"     # viola pastello
),labels = c(
"HMR" = "HMR",
"ORE" = "ORE",
"ORA" = "ORA",
"BUS" = "BUS",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
### Define function to compute fin asset share
calc_shares_fin <- function(design_obj, label) {
tot_MF      <- sum(svytotal(~HD1320b+HD1320c+HD1320d+HD1320e+HD1320f+HD1320g, design_obj, na.rm = TRUE)) # Mutual funds (excl. prev. equity)
tot_VOL     <- sum(svytotal(~DA2109, design_obj, na.rm = TRUE)) # Voluntary pensions and whole life insurance policies
tot_DEP      <- sum(svytotal(~DA2101, design_obj, na.rm = TRUE)) # Deposits
tot_BONDS <- sum(svytotal(~DA2103, design_obj, na.rm = TRUE)) # Bonds
tot_OFA      <- sum(svytotal(~DA2104+DA2106+DA2107+DA2108, design_obj, na.rm = TRUE)) # Other financial assets,
# managed accounts, money owed to households, other assets,
# non-employment business,
tot_ALLSTOCK <- sum(svytotal(~DA2105+HD1320a, design_obj, na.rm = TRUE)) # Stock + mutual funds that invest prevalently in shares
tot_fin    <- sum(svytotal(~HD1320b+HD1320c+HD1320d+HD1320e+HD1320f+HD1320g+DA2109+DA2101+
DA2103+DA2104+DA2106+DA2107+DA2108+DA2105+HD1320a, design_obj, na.rm = TRUE))  # Total  value financial assets
tibble(
quartile = as.character(label),
MF     = tot_MF / tot_fin,
VOL     = tot_VOL / tot_fin,
DEP     = tot_DEP / tot_fin,
BONDS     = tot_BONDS / tot_fin,
OFA    = tot_OFA / tot_fin,
ALLSTOCK = tot_ALLSTOCK / tot_fin
)
}
### General
gen_comp_fin <- calc_shares_fin(design, "General")
### By quartile
comp_fin_byquart <- map_dfr(1:4, ~calc_shares_fin(subset(design, quartile == .x), .x))
### Union
ptf_comp_fin <- bind_rows(gen_comp_fin, comp_fin_byquart)
View(ptf_comp_fin)
sum(ptf_comp_fin)
colsum(ptf_comp_fin)
colSums(ptf_comp_fin, na.rm = TRUE)
View(ptf_comp_fin)
ptf_comp_fin
ptf_comp_fin$Total <- rowSums(ptf_comp_fin[, -1], na.rm = TRUE)
rowSums(ptf_comp_fin[, -1], na.rm = TRUE)
ptf_comp_fin <- bind_rows(gen_comp_fin, comp_fin_byquart)
rowSums(ptf_comp_fin[, -1], na.rm = TRUE)
# Convert dataset in long format
ptf_long_fin <- ptf_comp_fin %>%
pivot_longer(
cols = MF:ALLSTOCK,
names_to = "Asset",
values_to = "Share"
)
# Grafico stacked con colori più soft
ggplot(ptf_long, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"MF" = "#ABCDEF",
"VOL" = "#FF9933",
"BONDS" = "#b2df8a",
"DEP" = "#33a02c",
"ALLSTOCK" = "#FF0000",
"OFA" = "#FDE910"
),labels = c(
"HMR" = "HMR",
"ORE" = "ORE",
"ORA" = "ORA",
"BUS" = "BUS",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
# Grafico stacked con colori più soft
ggplot(ptf_long, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"MF" = "#ABCDEF",
"VOL" = "#FF9933",
"BONDS" = "#b2df8a",
"DEP" = "#33a02c",
"ALLSTOCK" = "#FF0000",
"OFA" = "#FDE910"
),labels = c(
"MF" = "MF",
"VOL" = "VOL",
"BONDS" = "BONDS",
"DEP" = "DEP",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
### Define function to compute fin asset share
calc_shares_fin <- function(design_obj, label) {
tot_MF      <- sum(svytotal(~HD1320b+HD1320c+HD1320d+HD1320e+HD1320f+HD1320g, design_obj, na.rm = TRUE)) # Mutual funds (excl. prev. equity)
tot_VOL     <- sum(svytotal(~DA2109, design_obj, na.rm = TRUE)) # Voluntary pensions and whole life insurance policies
tot_DEP      <- sum(svytotal(~DA2101, design_obj, na.rm = TRUE)) # Deposits
tot_BONDS <- sum(svytotal(~DA2103, design_obj, na.rm = TRUE)) # Bonds
tot_OFA      <- sum(svytotal(~DA2104+DA2106+DA2107+DA2108, design_obj, na.rm = TRUE)) # Other financial assets,
# managed accounts, money owed to households, other assets,
# non-employment business,
tot_ALLSTOCK <- sum(svytotal(~DA2105+HD1320a, design_obj, na.rm = TRUE)) # Stock + mutual funds that invest prevalently in shares
tot_fin    <- sum(svytotal(~HD1320b+HD1320c+HD1320d+HD1320e+HD1320f+HD1320g+DA2109+DA2101+
DA2103+DA2104+DA2106+DA2107+DA2108+DA2105+HD1320a, design_obj, na.rm = TRUE))  # Total  value financial assets
tibble(
quartile = as.character(label),
MF     = tot_MF / tot_fin,
VOL     = tot_VOL / tot_fin,
DEP     = tot_DEP / tot_fin,
BONDS     = tot_BONDS / tot_fin,
OFA    = tot_OFA / tot_fin,
ALLSTOCK = tot_ALLSTOCK / tot_fin
)
}
### General
gen_comp_fin <- calc_shares_fin(design, "General")
### By quartile
comp_fin_byquart <- map_dfr(1:4, ~calc_shares_fin(subset(design, quartile == .x), .x))
### Union
ptf_comp_fin <- bind_rows(gen_comp_fin, comp_fin_byquart)
# Grafico stacked con colori più soft
ggplot(ptf_long_fin, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"MF" = "#ABCDEF",
"VOL" = "#FF9933",
"BONDS" = "#b2df8a",
"DEP" = "#33a02c",
"ALLSTOCK" = "#FF0000",
"OFA" = "#FDE910"
),labels = c(
"MF" = "MF",
"VOL" = "VOL",
"BONDS" = "BONDS",
"DEP" = "DEP",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
show_col(hue_pal()(7))
# Install and load necessary libraries
if (!require("dplyr", quietly = TRUE)) {install.packages("dplyr")}
if (!require("survey", quietly = TRUE)) {install.packages("survey")}
if (!require("Hmisc", quietly = TRUE)) {install.packages("Hmisc")}
if (!require("purrr", quietly = TRUE)) {install.packages("purr")}
if (!require("tidyverse", quietly = TRUE)) {install.packages("tidyverse")}
if (!require("scales", quietly = TRUE)) {install.packages("scales")}
library(dplyr)
library(survey)
library(Hmisc)
library(purrr)
library(tidyverse)
library(scales)
show_col(hue_pal()(7))
# Stacked chart
ggplot(ptf_long, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"HMR" = "#ABCDEF",
"ORE" = "#FF9933",
"ORA" = "#b2df8a",
"BUS" = "#33a02c",
"ALLSTOCK" = "#FF0000",
"OFA" = "#FDE910"
),labels = c(
"HMR" = "HMR",
"ORE" = "ORE",
"ORA" = "ORA",
"BUS" = "BUS",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
ggplot(ptf_long, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"HMR" = "#4169E1",
"ORE" = "#FF9933",
"ORA" = "#b2df8a",
"BUS" = "#33a02c",
"ALLSTOCK" = "#FF0000",
"OFA" = "#FDE910"
),labels = c(
"HMR" = "HMR",
"ORE" = "ORE",
"ORA" = "ORA",
"BUS" = "BUS",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
# Stacked chart
ggplot(ptf_long, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"HMR" = "#4169E1",
"ORE" = "#FF9933",
"ORA" = "#b2df8a",
"BUS" = "#33a02c",
"ALLSTOCK" = "#FF0000",
"OFA" = "#FFBF00"
),labels = c(
"HMR" = "HMR",
"ORE" = "ORE",
"ORA" = "ORA",
"BUS" = "BUS",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
# Stacked chart
ggplot(ptf_long, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"HMR" = "#4169E1",
"ORE" = "#FF9933",
"ORA" = "#1E90FF",
"BUS" = "#33a02c",
"ALLSTOCK" = "#FF0000",
"OFA" = "#FFBF00"
),labels = c(
"HMR" = "HMR",
"ORE" = "ORE",
"ORA" = "ORA",
"BUS" = "BUS",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
# Stacked chart
ggplot(ptf_long, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"HMR" = "#4169E1",
"ORE" = "#FF9933",
"ORA" = "#9966CC",
"BUS" = "#33a02c",
"ALLSTOCK" = "#FF0000",
"OFA" = "#FFBF00"
),labels = c(
"HMR" = "HMR",
"ORE" = "ORE",
"ORA" = "ORA",
"BUS" = "BUS",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
# Stacked chart
ggplot(ptf_long, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"HMR" = "#4169E1",
"ORE" = "#FF9933",
"ORA" = "#1E90FF",
"BUS" = "#33a02c",
"ALLSTOCK" = "#FF0000",
"OFA" = "#FFBF00"
),labels = c(
"HMR" = "HMR",
"ORE" = "ORE",
"ORA" = "ORA",
"BUS" = "BUS",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
# Stacked chart
ggplot(ptf_long, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"HMR" = "#4169E1",
"ORE" = "#FF9933",
"ORA" = "#33a02c",
"BUS" = "#1E90FF",
"ALLSTOCK" = "#FF0000",
"OFA" = "#FFBF00"
),labels = c(
"HMR" = "HMR",
"ORE" = "ORE",
"ORA" = "ORA",
"BUS" = "BUS",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
# Stacked chart
ggplot(ptf_long_fin, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"MF" = "#4169E1",
"VOL" = "#FF9933",
"BONDS" = "#33a02c",
"DEP" = "#1E90FF",
"ALLSTOCK" = "#FF0000",
"OFA" = "#FFBF00"),
labels = c(
"MF" = "MF",
"VOL" = "VOL",
"BONDS" = "BONDS",
"DEP" = "DEP",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
# Stacked chart
ggplot(ptf_long_fin, aes(x = quartile, y = Share, fill = Asset)) +
geom_col() +
scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
scale_fill_manual(values = c(
"MF" = "#4169E1",
"VOL" = "#FF9933",
"BONDS" = "#33a02c",
"DEP" =  "#FFBF00",
"ALLSTOCK" = "#FF0000",
"OFA" = "#1E90FF"),
labels = c(
"MF" = "MF",
"VOL" = "VOL",
"BONDS" = "BONDS",
"DEP" = "DEP",
"OFA" = "OFA",
"ALLSTOCK" = "ALL STOCK"
),  ) +
labs(# title = "Composizione del portafoglio per quartile di ricchezza netta",
x = "Quartile di ricchezza",
y = "Quota (%)"
) +
theme_minimal() +
theme(legend.title = element_blank())
